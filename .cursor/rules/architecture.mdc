---
globs: 
  - "**/*.{ts,tsx,py,yaml,yml}"
  - "!**/{node_modules,__pycache__,.next,dist,build}/**"
---

# Zeus Architecture Guidelines

## üèóÔ∏è System Overview

Zeus is a next-generation AI multi-agent platform with a modern full-stack architecture:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Next.js Frontend (Port 3000)       ‚îÇ
‚îÇ   ‚îú‚îÄ Better Auth + Drizzle ORM             ‚îÇ
‚îÇ   ‚îú‚îÄ Shadcn/UI Components                  ‚îÇ
‚îÇ   ‚îî‚îÄ TypeScript + Tailwind CSS             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ HTTP/SSE
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        Python Backend (Port 8000)           ‚îÇ
‚îÇ   ‚îú‚îÄ FastAPI Framework                     ‚îÇ
‚îÇ   ‚îú‚îÄ LangChain Agents                      ‚îÇ
‚îÇ   ‚îú‚îÄ MCP (Model Context Protocol)          ‚îÇ
‚îÇ   ‚îî‚îÄ DeepAgents Research                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         PostgreSQL (Neon DB)                ‚îÇ
‚îÇ   ‚îú‚îÄ User Authentication                   ‚îÇ
‚îÇ   ‚îú‚îÄ Chat Sessions & Messages              ‚îÇ
‚îÇ   ‚îú‚îÄ MCP Server Configurations             ‚îÇ
‚îÇ   ‚îî‚îÄ LangGraph Checkpoints                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÅ Project Structure

```
Zeus/
‚îú‚îÄ‚îÄ frontend/                    # Next.js Application
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/                # App Router Pages
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [locale]/       # i18n Routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api/            # Next.js API Routes (Proxy)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/         # React Components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/           # Chat Interface
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modals/         # Configuration Modals
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/         # Header, Sidebar, etc.
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/             # Shadcn/UI Components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/                # Utilities
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db/             # Database Client & Schema
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema/     # Drizzle Schemas by Domain
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/           # Better Auth Client
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/          # React Hooks
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ message-handlers/ # SSE Message Handlers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ i18n/               # Internationalization
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ store/              # Zustand Stores
‚îÇ   ‚îî‚îÄ‚îÄ drizzle.config.ts       # Drizzle Kit Config
‚îÇ
‚îú‚îÄ‚îÄ backend/                     # Python Backend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                # FastAPI Routers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py         # Main Application
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py         # Auth Endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chats.py        # Chat Endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sessions.py     # Session Management
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mcp.py          # MCP Validation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/           # Business Logic
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_service.py # Base Service Class
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat_service.py # Agent Chat Service
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deep_research.py # Deep Research Service
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/              # Utilities
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manager/        # Configuration Managers
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm_manager.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mcp_manager.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompt_manager.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools/          # Custom Tools
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.py       # Logging
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ langgraph_checkpoint.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repository/         # Data Models
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ models/         # Pydantic Models
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ prompts/        # System Prompts
‚îÇ   ‚îî‚îÄ‚îÄ configs/                # Configuration Files
‚îÇ       ‚îú‚îÄ‚îÄ llm.yaml            # LLM Model Config
‚îÇ       ‚îú‚îÄ‚îÄ mcp.yaml            # MCP Server Config
‚îÇ       ‚îî‚îÄ‚îÄ supabase.yaml       # Database Config
‚îÇ
‚îî‚îÄ‚îÄ docker/                      # Docker Configuration
    ‚îú‚îÄ‚îÄ docker-compose.yml
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îî‚îÄ‚îÄ start.sh
```

## üîÑ Request Flow

### Agent Chat Request Flow
```
1. User Input (Frontend)
   ‚îî‚îÄ> ChatInterface.tsx
       ‚îî‚îÄ> stream-processor.ts
2. Next.js API Proxy
   ‚îî‚îÄ> /api/invoke-agent/route.ts
       ‚îú‚îÄ Verify session (Better Auth)
       ‚îú‚îÄ Fetch user's MCP servers from DB
       ‚îú‚îÄ Save message to DB
       ‚îî‚îÄ> Proxy to Python Backend
3. Python Backend
   ‚îî‚îÄ> /api/invoke-agent (FastAPI)
       ‚îú‚îÄ ChatService.invoke()
       ‚îÇ   ‚îú‚îÄ Initialize LLM (via LLMManager)
       ‚îÇ   ‚îú‚îÄ Initialize MCP tools
       ‚îÇ   ‚îú‚îÄ Bind tools to model
       ‚îÇ   ‚îî‚îÄ Stream response (astream)
       ‚îî‚îÄ> SSE Response Stream
4. Frontend Processing
   ‚îî‚îÄ> SSE handlers process chunks
       ‚îú‚îÄ text-handler.ts
       ‚îú‚îÄ tool-call-handler.ts
       ‚îú‚îÄ tool-result-handler.ts
       ‚îî‚îÄ complete-handler.ts
```

### Deep Research Request Flow
```
1. User Query (Frontend)
   ‚îî‚îÄ> ChatInterface.tsx
2. Next.js API Proxy
   ‚îî‚îÄ> /api/invoke-deep-research/route.ts
3. Python Backend
   ‚îî‚îÄ> /api/invoke-deep-research (FastAPI)
       ‚îú‚îÄ DeepResearchService.invoke()
       ‚îÇ   ‚îú‚îÄ Create DeepAgents agent
       ‚îÇ   ‚îú‚îÄ Stream via LangGraph
       ‚îÇ   ‚îî‚îÄ Save checkpoints (DrizzleCheckpointSaver)
       ‚îî‚îÄ> SSE Response Stream
           ‚îú‚îÄ todo: TodoList generation
           ‚îú‚îÄ think: Agent thinking process
           ‚îú‚îÄ task: Task execution updates
           ‚îú‚îÄ tool_call: Tool invocations
           ‚îî‚îÄ complete: Research complete
```

## üîå API Design Principles

### 1. Backend API (Python FastAPI)
**Purpose**: Pure AI/Agent logic, no database operations

**Endpoints**:
- `POST /api/invoke-agent` - Agent mode chat with tool calling
- `POST /api/invoke-deep-research` - Start deep research
- `POST /api/resume-deep-research` - Resume paused research
- `POST /api/mcp/validate` - Validate MCP server connection

**Response Format**: Server-Sent Events (SSE)
```
data: {"type": "text", "content": "..."}
data: {"type": "tool_call", "tool_name": "...", "parameters": {...}}
data: {"type": "tool_call_result", "result": "..."}
data: {"type": "complete"}
```

### 2. Frontend API (Next.js API Routes)
**Purpose**: Authentication, database operations, proxy to backend

**Endpoints**:
- `GET/POST/PUT/DELETE /api/mcp` - MCP server CRUD
- `POST /api/mcp/validate` - Validate MCP server
- `POST /api/auth/[...all]` - Better Auth endpoints
- `POST /api/invoke-agent` - Proxy to Python backend
- `POST /api/invoke-deep-research` - Proxy to Python backend
- `POST /api/resume-deep-research` - Proxy to Python backend

## üì¶ Key Technologies

### Frontend Stack
- **Framework**: Next.js 16 (App Router)
- **Language**: TypeScript
- **UI**: Shadcn/UI + Radix UI + Tailwind CSS
- **Auth**: Better Auth (replaces Supabase Auth)
- **Database**: Drizzle ORM + PostgreSQL
- **State**: React Context + Zustand
- **i18n**: next-intl (English + Chinese)

### Backend Stack
- **Framework**: FastAPI
- **Language**: Python 3.11+
- **AI**: LangChain + LangGraph
- **Agents**: DeepAgents
- **Tools**: langchain-mcp-adapters
- **Config**: YAML-based configuration

### Database
- **Provider**: Neon (PostgreSQL)
- **ORM**: Drizzle ORM (TypeScript)
- **Schema**: Organized by domain
  - `user.ts` - Better Auth tables
  - `chat.ts` - Chat sessions & messages
  - `mcp.ts` - MCP server configurations
  - `langgraph.ts` - LangGraph checkpoints

## üéØ Architectural Patterns

### 1. Service Layer Pattern (Backend)
All AI services inherit from `BaseService`:
```python
class BaseService(ABC):
    def _init_model(self) -> LLM
    async def _init_mcp_tools(self, mcp_servers) -> List[Tool]
    def _build_message_history(self, chat_history) -> List[Message]
    async def _handle_error(self, error) -> AsyncGenerator
    
    @abstractmethod
    async def invoke(self, *args, **kwargs) -> AsyncGenerator
```

### 2. Repository Pattern (Frontend)
Database operations centralized in Next.js API routes:
- User authentication handled by Better Auth
- Business data (chat, mcp) via Drizzle ORM
- All operations behind authentication checks

### 3. Proxy Pattern (API Routes)
Next.js API routes act as authenticated proxies:
- Verify user session
- Perform database operations
- Forward to Python backend with context
- Return streaming responses

### 4. Message Handler Pattern (Frontend)
SSE message processing split by type:
- `text-handler.ts` - Text chunks
- `tool-call-handler.ts` - Tool invocations
- `tool-result-handler.ts` - Tool results
- `complete-handler.ts` - Completion
- `error-handler.ts` - Errors

## üîê Security Architecture

1. **Authentication**: Better Auth with GitHub OAuth
2. **Session Management**: JWT tokens + database sessions
3. **API Security**: Session verification in all API routes
4. **Database Security**: User-scoped queries with foreign keys
5. **MCP Security**: Per-user MCP server configurations

## üìä Data Flow Architecture

### User-Specific Data
All user data isolated by `userId`:
- Chat sessions
- Messages
- MCP server configurations
- LangGraph checkpoints (optional)

### Configuration Management
- **Global**: `backend/configs/*.yaml` (LLM, default MCP)
- **User-Specific**: Database (user's custom MCP servers)
- **Runtime**: Service initialization from both sources

## üöÄ Deployment Architecture

### Development
```bash
make dev  # Runs frontend + backend concurrently
```

### Production (Docker)
```yaml
services:
  app:
    build: .
    ports:
      - "3000:3000"  # Next.js frontend
      - "8000:8000"  # FastAPI backend
    environment:
      - DATABASE_URL
      - AUTH_SECRET
      - GITHUB_CLIENT_ID
      - GITHUB_CLIENT_SECRET
```

## üìù Best Practices

1. **Separation of Concerns**: Frontend for UI/Auth/DB, Backend for AI logic
2. **Type Safety**: TypeScript frontend, Pydantic backend
3. **Modularity**: Services, handlers, and schemas organized by domain
4. **Configuration**: YAML for backend, env vars for secrets
5. **Error Handling**: Consistent patterns across layers
6. **Logging**: Structured logging with context
7. **Streaming**: SSE for real-time AI responses
8. **Checkpointing**: LangGraph state persistence for long-running tasks
